# Package Base
[![Build Status](https://api.travis-ci.org/WsdlToPhp/PackageBase.svg)](https://travis-ci.org/WsdlToPhp/PackageBase)
[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/WsdlToPhp/PackageBase/badges/quality-score.png)](https://scrutinizer-ci.com/g/WsdlToPhp/PackageBase/)
[![Code Coverage](https://scrutinizer-ci.com/g/WsdlToPhp/PackageBase/badges/coverage.png)](https://scrutinizer-ci.com/g/WsdlToPhp/PackageBase/)
[![Dependency Status](https://www.versioneye.com/user/projects/5571b32b6634650018000011/badge.svg)](https://www.versioneye.com/user/projects/5571b32b6634650018000011)

## Main features
This project contains base classes used as parent class by the generated classes from [PackageGenerator](https://github.com/WsdlToPhp/PackageGenerator).

## How to
### AbstractStructBase
#### Description

This class is the base class for any ```StructType``` class generated by [PackageGenerator](https://github.com/WsdlToPhp/PackageGenerator).
It defines three methods:
- **__set_state($array)**: Usefull when you load the string representation of an object that you stored using ```var_export```. It also allows you to ease the instanciation of an object that contains many properties which would be hard to instanciate using the __construct method. You can see ```__set_state``` as an hydratation method.
- **_set($name, $value)**: As magic method ```__set``` but used by the ```__set_state``` method. Plus, defining ```__set``` method on used class by the classmap option for the SoapClient breaks the correct hydratation of your received objects.
- **_get($name)**: As magic method ```__get```. Used by ```AbstractStructArrayBase``` class

#### Usage
```php
$item = \Api\StructType\Item::__set_state(array(
    'id' => 1,
    'name' => 'Entity #1',
    'label' => 'Entity #1',
    '_href' => 'http://www.entity.com',
));
// $item is now an \Api\StructType\Item object
```

### AbstractStructArrayBase
#### Description

This class is the base class for any ```ArrayType``` class generated by [PackageGenerator](https://github.com/WsdlToPhp/PackageGenerator).
Its goal is to provide utility/handful methods by implementing ```ArrayAccess```, ```Iterator``` and ```Countable``` PHP interfaces.

#### Usage
As soon as you have an element that is an array of items such as:
```php
$items = \Api\ArrayType\Items::__set_state(array(
    'items' => array(
        \Api\StructType\Item::__set_state(array(
            'id' => 1,
            'name' => 'Entity #1',
            'label' => 'Entity #1',
            '_href' => 'http://www.entity-1.com',
        ),
        \Api\StructType\Item::__set_state(array(
            'id' => 2,
            'name' => 'Entity #2',
            'label' => 'Entity #2',
            '_href' => 'http://www.entity-2.com',
        ),
        \Api\StructType\Item::__set_state(array(
            'id' => 3,
            'name' => 'Entity #3',
            'label' => 'Entity #3',
            '_href' => 'http://www.entity-3.com',
        ),
    )
));
// 'items' is the unique property of the object
// Its name is returned by the getAttributeName method
// defined in the generated \Api\ArrayType\Items class
```
- **YOU must call first** ```initInternArray``` method on your ArrayType object otherwise you'll get nothing:
```php
$items->initInternArray();
```
- then you can call ```count```, ```length``` methods: gives you the number of items contained by your object
- you can iterate through the items:
```php
foreach ($items as $item) {
    // $items->current() and $item is an \Api\StructType\Item object
    // $items->key() is the current index
}
```
- you can get the first item:
```php
$items->first();
```
- you can get the last item:
```php
$items->last();
```
- you can get any item:
```php
$items->item($index);
```
- you can add a new item:
```php
$items->add(\Api\StructType\Item::__set_state(array(
    'id' => 4,
    'name' => 'Entity #4',
    'label' => 'Entity #4',
    '_href' => 'http://www.entity-4.com',
)));
```
- you can even reset the items:
```php
$items->initInternArray(array(
    \Api\StructType\Item::__set_state(array(
        'id' => 0,
        'name' => 'Entity #0',
        'label' => 'Entity #0',
        '_href' => 'http://www.entity-0.com',
    ),
    \Api\StructType\Item::__set_state(array(
        'id' => 1,
        'name' => 'Entity #1',
        'label' => 'Entity #1',
        '_href' => 'http://www.entity-1.com',
    ),
    \Api\StructType\Item::__set_state(array(
        'id' => 2,
        'name' => 'Entity #2',
        'label' => 'Entity #2',
        '_href' => 'http://www.entity-2.com',
    ),
));
```

### AbstractSoapClientBase
#### Description

This class is the base class for any ```ServiceType``` class generated by [PackageGenerator](https://github.com/WsdlToPhp/PackageGenerator).
Its goal is to provide utility/handful methods by implementing ```SoapClientInterface```.
It's basically a decorator design pattern as the class has the ```SoapClient``` object as a static property in order to be able apply methods on it. It is static property in order to have a singleton between multiple calls. It can be reset by passing true as the second parameter.

#### Usage
Let's say you have this type of generate ServiceType's class:
```php
namespace Api\ServiceType;
class ApiUpdate extends AbstractSoapClientBase
{
    public function UpdateBulkOrder(\Api\StructType\ApiUpdateBulkOrder $parameters)
    {
        try {
            $this->setResult(self::getSoapClient()->UpdateBulkOrder($parameters));
            return $this->getResult();
        } catch (\SoapFault $soapFault) {
            $this->saveLastError(__METHOD__, $soapFault);
            return false;
        }
    }
}
```
You can do:
```php
use \WsdlToPhp\PackageBase\AbstractSoapClientBase;
$options = array(
    AbstractSoapClientBase::WSDL_URL => '__WSDL_URL__',
    AbstractSoapClientBase::WSDL_CLASSMAP => \Api\ApiClassMap::classMap(),
);
// sets the first instance of SoapClient within  AbstractSoapClientBase
$update = new \Api\ServiceType\ApiUpdate($options);
// resets the SoapClient instance
$update = new \Api\ServiceType\ApiUpdate($options, true);
```
Then call any of these base methods:
- **getResult**: return the actual response as an object. The object's class should be a generated class
- **getLastRequest($asDomDocument = false)**: returns either the XML string version or the ```DOMDocument``` version of the request
- **getLastResponse($asDomDocument = false)**: returns either the XML string version or the ```DOMDocument``` version of the response
- **getLastRequestHeaders($asArray = false)**: returns either the HTTP request's headers as a string or as an array (each HTTP header is parsed)
- **getLastResponseHeaders($asArray = false)**: returns either the HTTP response's headers as a string or as an array
- **getLastError**: automatically populated with an error when ```$this->saveLastError(__METHOD__, $soapFault);``` is called
- **getLastErrorForMethod($methoName)** : returns the error associated to the called method. It should return a ```SoapFault``` object
```php
$ok = $update->UpdateBulkOrder(new \Api\StructType\ApiUpdateBulkOrder())
if ($ok !== false) {
    echo "\nThis is the result as an object:" . print_r($update->getResult(), true);
} else {
    echo "\nThis is the XML request:" . $update->getLastRequest(false);
    echo "\nThese are the request's headers:" . $update->getLastRequestHeaders(false);
    echo "\nThis is the XML response:" . $update->getLastResponse(false);
    echo "\nThese are the response's headers:" . $update->getLastResponseHeaders(false);
    echo "\nThese are the last errors:" . print_r($update->getLastError(), true);
    echo "\nThis is the current error:" . print_r($update->getLastErrorForMethod('\Api\ServiceType\ApiUpdate::UpdateBulkOrder'), true);
    }
```
You have additional methods such as:
- **setSoapHeader($nameSpace, $name, $data, $mustUnderstand = false, $actor = null)**: it provides a way to redefine SoapHeaders
```php
// A sample of its usage in the generated ServiceType class
public function setSoapHeaderCSPCHD(\Api\StructType\ApiCSPCHD $cSPCHD, $nameSpace = 'http://tempuri.org', $mustUnderstand = false, $actor = null)
{
    return $this->setSoapHeader($nameSpace, 'CSPCHD', $cSPCHD, $mustUnderstand, $actor);
}
```
- **setHttpHeader($headerName, $headerValue)**: an easy way to define your proper HTTP headers that must be sent
- **setLocation($location)**: Sets the location of the Web service to use

### SoapClientInterface
#### Description

This interface is the base interface that must be used to define a new ```SoapClient``` base class for any ```ServiceType``` class generated by [PackageGenerator](https://github.com/WsdlToPhp/PackageGenerator).


## Need improvements for these classes?
Feel free to make some pull requests. We'll study them and let you know when it can be integrated.

## Unit tests
You can run the unit tests with the following command:
```
    $ cd /path/to/src/WsdlToPhp/PackageBase/
    $ composer install
    $ phpunit
```